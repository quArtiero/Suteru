{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/suggest_question.css') }}">
<!-- Quill CSS for preview formatting -->
<style>
/* Additional Quill formatting for preview */
.preview-question-box .ql-editor,
.option-content.ql-editor {
    font-family: inherit !important;
    font-size: inherit !important;
    line-height: inherit !important;
    color: inherit !important;
    padding: 0 !important;
    border: none !important;
    background: transparent !important;
}

.preview-question-box .ql-editor p,
.option-content.ql-editor p {
    margin: 0.3em 0;
}

.preview-question-box .ql-editor p:first-child,
.option-content.ql-editor p:first-child {
    margin-top: 0;
}

.preview-question-box .ql-editor p:last-child,
.option-content.ql-editor p:last-child {
    margin-bottom: 0;
}

/* Progressive Steps Styling */
.step-section {
    background: white;
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    margin-bottom: var(--space-4);
    box-shadow: var(--shadow-sm);
    border: 2px solid transparent;
    transition: all var(--transition-base);
    opacity: 0.6;
}

.step-section.active {
    opacity: 1;
    border-color: var(--primary-200);
    box-shadow: var(--shadow-lg);
    background: linear-gradient(135deg, #f8faff 0%, #ffffff 100%);
}

.step-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-3);
    border-bottom: 1px solid var(--border-light);
}

.step-number {
    width: 32px;
    height: 32px;
    background: var(--gradient-primary);
    color: white;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: var(--text-sm);
    box-shadow: var(--shadow-sm);
}

.step-title {
    margin: 0;
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--text-primary);
}

.step-section:not(.active) .step-number {
    background: var(--gray-300);
    color: var(--gray-600);
}

.step-section:not(.active) .step-title {
    color: var(--text-secondary);
}

/* Admin Badge Styling */
.admin-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: var(--shadow-md);
    margin-left: 1rem;
    animation: pulse 2s infinite;
}

.admin-badge i {
    font-size: 1.1em;
}

@keyframes pulse {
    0%, 100% {
        transform: scale(1);
    }
    50% {
        transform: scale(1.05);
    }
}

/* Colaborador Badge Styling */
.colaborador-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    box-shadow: var(--shadow-md);
    margin-left: 1rem;
    animation: pulse 2s infinite;
}

.colaborador-badge i {
    font-size: 1.1em;
}

/* Image Upload Styling */
.image-upload-container {
    border: 2px dashed var(--primary-300);
    border-radius: var(--radius-lg);
    background: rgba(59, 130, 246, 0.02);
    transition: all var(--transition-base);
    position: relative;
    overflow: hidden;
}

.image-upload-container:hover {
    border-color: var(--primary-500);
    background: rgba(59, 130, 246, 0.05);
}

.image-input {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 2;
}

.image-upload-placeholder {
    text-align: center;
    padding: var(--space-8);
    color: var(--text-secondary);
    transition: all var(--transition-base);
}

.image-upload-placeholder i {
    font-size: var(--text-4xl);
    color: var(--primary-400);
    margin-bottom: var(--space-4);
    display: block;
}

.image-upload-placeholder p {
    font-size: var(--text-lg);
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: var(--space-2);
}

.image-upload-placeholder small {
    font-size: var(--text-sm);
    color: var(--text-tertiary);
}

.image-preview {
    position: relative;
    border-radius: var(--radius-lg);
    overflow: hidden;
}

.image-preview img {
    width: 100%;
    max-height: 300px;
    object-fit: contain;
    background: var(--gray-50);
    border-radius: var(--radius-lg);
}

.remove-image-btn {
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
    background: var(--error-500);
    color: white;
    border: none;
    border-radius: var(--radius-full);
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all var(--transition-base);
    box-shadow: var(--shadow-md);
}

.remove-image-btn:hover {
    background: var(--error-600);
    transform: scale(1.1);
}

/* Ensure all Quill formatting is preserved */
.ql-editor strong,
.preview-question-box strong,
.option-content strong {
    font-weight: bold !important;
}

.ql-editor em,
.preview-question-box em,
.option-content em {
    font-style: italic !important;
}

.ql-editor u,
.preview-question-box u,
.option-content u {
    text-decoration: underline !important;
}

.ql-editor s,
.preview-question-box s,
.option-content s {
    text-decoration: line-through !important;
}
</style>
{% endblock %}

{% block content %}
<div class="suggest-question-container">
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-icon">
            <i class="fas fa-lightbulb"></i>
        </div>
        <h1 class="hero-title">Contribua com o Conhecimento</h1>
        <p class="hero-subtitle">
            Sua pergunta pode ajudar milhares de estudantes e gerar mais doações para quem precisa
        </p>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div>
                    <div class="stat-value">+500</div>
                    <div class="stat-label">Estudantes beneficiados</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-seedling"></i>
                </div>
                <div>
                                <div class="stat-value">+1.6g</div>
            <div class="stat-label">Alimento doado por questão</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Form -->
    <div class="main-form-card">
        <form method="POST" id="suggest-form" enctype="multipart/form-data">
            <!-- Progressive Form Steps -->
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-list-ol"></i>
                </div>
                <h2 class="section-title">
                    Configuração da Questão
                    {% if is_admin %}
                    <span class="admin-badge">
                        <i class="fas fa-crown"></i>
                        ADMIN - Submissão Direta
                    </span>
                    {% elif is_colaborador %}
                    <span class="colaborador-badge">
                        <i class="fas fa-star"></i>
                        COLABORADOR - Submissão Direta
                    </span>
                    {% endif %}
                </h2>
                <p class="section-subtitle">
                    {% if can_bypass %}
                        {% if is_admin %}
                        Como administrador, suas questões são adicionadas diretamente ao banco de dados
                        {% else %}
                        Como colaborador, suas questões são adicionadas diretamente ao banco de dados
                        {% endif %}
                    {% else %}
                    Preencha as informações passo a passo - sua questão será revisada por um administrador
                    {% endif %}
                </p>
            </div>
            
            <!-- Step 1: Choose Subject -->
            <div class="step-section active" id="step-1">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <h4 class="step-title">Escolha a Matéria</h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="topic">
                        <i class="fas fa-book"></i>
                        Matéria
                    </label>
                    <select class="form-control" id="topic" name="topic" required>
                        <option value="" disabled selected>Selecione a matéria</option>
                        {% for topic in topics %}
                        <option value="{{ topic }}">{{ topic }}</option>
                        {% endfor %}
                        <option value="novo_tema">➕ Nova Matéria</option>
                    </select>
                    <input type="text" class="form-control mt-2" id="new_topic" name="new_topic" 
                           style="display: none;" placeholder="Digite a nova matéria">
                </div>
            </div>

            <!-- Step 2a: SAT Configuration -->
            <div class="step-section" id="step-2a" style="display: none;">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <h4 class="step-title">Configuração SAT</h4>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="sat_section">
                                <i class="fas fa-university"></i>
                                Seção SAT
                            </label>
                            <select class="form-control" id="sat_section" name="sat_section">
                                <option value="" disabled selected>Selecione a seção</option>
                                <option value="english">📚 English Reading & Writing</option>
                                <option value="math">🔢 Math</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="sat_level">
                                <i class="fas fa-star"></i>
                                Nível
                            </label>
                            <select class="form-control" id="sat_level" name="sat_level">
                                <option value="" disabled selected>Selecione o nível</option>
                                <option value="Level 1">⭐ Level 1 - Iniciante</option>
                                <option value="Level 2">⭐⭐ Level 2 - Intermediário</option>
                                <option value="Level 3">⭐⭐⭐ Level 3 - Avançado</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2b: Regular Grade Selection -->
            <div class="step-section" id="step-2b" style="display: none;">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <h4 class="step-title">Escolha a Série</h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="grade">
                        <i class="fas fa-graduation-cap"></i>
                        Série Escolar
                    </label>
                    <select class="form-control" id="grade" name="grade">
                        <option value="" disabled selected>Selecione a série</option>
                        {% for grade in grades %}
                        <option value="{{ grade }}">{{ grade }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Hidden default values -->
            <input type="hidden" name="difficulty" value="medio">
            <input type="hidden" name="points" value="10">

            <!-- Question Section -->
            <div class="section-header mt-5">
                <div class="section-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <h2 class="section-title">Criação da Questão</h2>
            </div>

            <!-- Question Editor -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-pen"></i>
                    Pergunta
                </label>
                <div class="editor-wrapper">
                    <div id="question-editor" style="min-height: 120px;"></div>
                </div>
                <input type="hidden" name="question">
            </div>

            <!-- Correct Answer -->
            <div class="form-group">
                <label class="form-label text-success">
                    <i class="fas fa-check-circle"></i>
                    Resposta Correta
                </label>
                <div class="editor-wrapper correct-answer-wrapper">
                    <div class="correct-answer-badge">
                        <i class="fas fa-check"></i>
                        CORRETA
                    </div>
                    <div id="correct-answer-editor" style="min-height: 120px;"></div>

                </div>
                <input type="hidden" name="correct_answer">
            </div>

            <!-- Incorrect Options -->
            <div class="incorrect-options-section">
                <div class="options-header">
                    <label class="form-label text-warning mb-0">
                        <i class="fas fa-times-circle"></i>
                        Alternativas Incorretas
                    </label>
                    <span class="text-muted">3 alternativas obrigatórias</span>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="option-card">
                            <div class="option-number">1</div>
                            <div class="editor-wrapper" style="margin-left: 40px;">
                                <div id="option1-editor" style="min-height: 100px;"></div>
                            </div>
                            <input type="hidden" name="option1">
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="option-card">
                            <div class="option-number">2</div>
                            <div class="editor-wrapper" style="margin-left: 40px;">
                                <div id="option2-editor" style="min-height: 100px;"></div>
                            </div>
                            <input type="hidden" name="option2">
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="option-card">
                            <div class="option-number">3</div>
                            <div class="editor-wrapper" style="margin-left: 40px;">
                                <div id="option3-editor" style="min-height: 100px;"></div>
                            </div>
                            <input type="hidden" name="option3">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campo hidden para option4 (compatibilidade com BD) -->
            <input type="hidden" name="option4" value="">
            
            <!-- Step 3: Optional Image Upload -->
            <div class="step-section" id="step-3">
                <div class="step-header">
                    <span class="step-number">3</span>
                    <h4 class="step-title">📷 Imagem da Questão <span style="color: #6b7280; font-weight: 400;">(OPCIONAL)</span></h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="question_image">
                        <i class="fas fa-image"></i>
                        Upload de Imagem para Questão <strong style="color: #10b981;">(OPCIONAL)</strong>
                        <span class="field-subtitle">Para gráficos, tabelas, DATA questions, etc. (PNG, JPG - máx 5MB) - Pule se não precisar!</span>
                    </label>
                    <div class="image-upload-container">
                        <input type="file" id="question_image" name="question_image" accept="image/png,image/jpeg,image/jpg" class="image-input">
                        <div class="image-preview" id="image-preview" style="display: none;">
                            <img id="preview-img" src="" alt="Preview da questão">
                            <button type="button" class="remove-image-btn" onclick="removeImage()">
                                <i class="fas fa-times"></i> Remover
                            </button>
                        </div>
                        <div class="image-upload-placeholder" id="upload-placeholder">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Clique para selecionar uma imagem</p>
                            <small>PNG, JPG até 5MB</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="submit-section">
                <button type="submit" class="submit-btn btn-secondary" id="submit-btn" disabled>
                    <i class="fas fa-lock"></i>
                    {% if can_bypass %}
                    Complete todos os campos para adicionar
                    {% else %}
                    Complete todos os campos para sugerir
                    {% endif %}
                </button>
            </div>
        </form>
    </div>

    <!-- Preview Section (Now at the bottom) -->
    <div class="preview-section-bottom">
        <div class="preview-card">
            <div class="preview-header">
                <i class="fas fa-desktop"></i>
                <h3 class="preview-title">Preview do Quiz</h3>
                <p class="preview-subtitle">Veja como sua questão aparecerá para os alunos</p>
            </div>

            <div class="preview-content">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="preview-question-box">
                            <div class="question-label">
                                <i class="fas fa-question-circle"></i>
                                PERGUNTA
                            </div>
                            <div id="preview-question">
                                <em>Digite sua pergunta para visualizar...</em>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6">
                        <div class="options-label">
                            <i class="fas fa-list"></i>
                            ALTERNATIVAS
                        </div>
                        
                        <div class="preview-options">
                            <div class="preview-option" id="preview-option-a">
                                <div class="option-letter">A</div>
                                <div class="option-content" id="preview-content-a">
                                    <em>Aguardando conteúdo...</em>
                                </div>
                                <i class="fas fa-check correct-check" style="display: none;"></i>
                            </div>

                            <div class="preview-option" id="preview-option-b">
                                <div class="option-letter">B</div>
                                <div class="option-content" id="preview-content-b">
                                    <em>Aguardando conteúdo...</em>
                                </div>
                                <i class="fas fa-check correct-check" style="display: none;"></i>
                            </div>

                            <div class="preview-option" id="preview-option-c">
                                <div class="option-letter">C</div>
                                <div class="option-content" id="preview-content-c">
                                    <em>Aguardando conteúdo...</em>
                                </div>
                                <i class="fas fa-check correct-check" style="display: none;"></i>
                            </div>

                            <div class="preview-option" id="preview-option-d">
                                <div class="option-letter">D</div>
                                <div class="option-content" id="preview-content-d">
                                    <em>Aguardando conteúdo...</em>
                                </div>
                                <i class="fas fa-check correct-check" style="display: none;"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="preview-meta">
                    <div class="meta-item">
                        <div class="meta-label">Série:</div>
                        <div class="meta-value" id="meta-grade">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Matéria:</div>
                        <div class="meta-value" id="meta-topic">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Dificuldade:</div>
                        <div class="meta-value" id="meta-difficulty">-</div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-label">Pontos:</div>
                        <div class="meta-value" id="meta-points">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variáveis globais
let editors = {};

// Funções de emergência (mantidas para casos especiais)

window.exitTestMode = function() {
    window.TESTING_MODE = false;
    
    // Parar proteção da opção A
    if (window.protectOptionA) {
        clearInterval(window.protectOptionA);
        window.protectOptionA = null;
        console.log('🛡️ Proteção da opção A DESATIVADA');
    }
    
    // Parar observador se estiver ativo
    if (window.optionAObserver) {
        window.optionAObserver.disconnect();
        window.optionAObserver = null;
        console.log('👀 Observador DESATIVADO');
    }
    
    console.log('🔓 MODO TESTE DESATIVADO - updatePreview reativado');
    alert('🔓 Modo teste desativado! Proteção e observador desligados.');
};

window.watchOptionA = function() {
    const optionA = document.getElementById('preview-option-a');
    if (!optionA) {
        alert('❌ Opção A não encontrada!');
        return;
    }
    
    console.log('👀 Iniciando observação da opção A...');
    
    // Observar mudanças na opção A
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                console.log('🔄 CLASSE da opção A mudou!');
                console.log('  - Nova classe:', optionA.className);
                console.log('  - Tem is-correct:', optionA.classList.contains('is-correct'));
                console.trace('📍 Quem mudou a classe:');
            }
            if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                console.log('🎨 STYLE da opção A mudou!');
                console.log('  - Novo style:', optionA.style.cssText);
                console.trace('📍 Quem mudou o style:');
            }
            if (mutation.type === 'childList') {
                console.log('📝 CONTEÚDO da opção A mudou!');
                console.trace('📍 Quem mudou o conteúdo:');
            }
        });
    });
    
    observer.observe(optionA, {
        attributes: true,
        childList: true,
        subtree: true,
        attributeFilter: ['class', 'style']
    });
    
    alert('👀 Observador ativado! Agora vou rastrear TUDO que mexe na opção A.');
    
    // Guardar referência para poder parar depois
    window.optionAObserver = observer;
};

window.testRealLogic = function() {
    if (!editors.correct_answer) {
        alert('❌ Editores ainda não estão prontos!');
        return;
    }
    
    console.log('🧪 === TESTE DA LÓGICA REAL ===');
    
    // Adicionar conteúdo de teste aos editores
    editors.correct_answer.setText('Esta é a resposta correta de teste!');
    if (editors.option1) editors.option1.setText('Opção incorreta 1');
    if (editors.option2) editors.option2.setText('Opção incorreta 2'); 
    if (editors.option3) editors.option3.setText('Opção incorreta 3');
    
    console.log('📝 Conteúdo adicionado aos editores Quill');
    
    // Ativar modo teste antes de chamar updatePreview
    window.TESTING_MODE = true;
    console.log('🔒 Modo teste ativado');
    
    // Chamar a função updatePreview ORIGINAL uma vez
    window.TESTING_MODE = false; // Permitir uma execução
    console.log('🔄 Chamando updatePreview uma vez...');
    window.updatePreview();
    
    // Reativar proteção
    window.TESTING_MODE = true;
    console.log('🔒 Modo teste reativado - updatePreview pausado novamente');
    
    alert('🧪 Teste da lógica real executado! Veja se a resposta correta apareceu no preview.');
};

window.testNormal = function() {
    // Desativar TODOS os modos de teste
    window.TESTING_MODE = false;
    
    // Parar proteção se estiver ativa
    if (window.protectOptionA) {
        clearInterval(window.protectOptionA);
        window.protectOptionA = null;
    }
    
    // Parar observador se estiver ativo
    if (window.optionAObserver) {
        window.optionAObserver.disconnect();
        window.optionAObserver = null;
    }
    
    // Limpar todas as opções primeiro
    ['a', 'b', 'c', 'd'].forEach(letter => {
        const el = document.getElementById(`preview-option-${letter}`);
        const content = document.getElementById(`preview-content-${letter}`);
        if (el && content) {
            el.classList.remove('is-correct');
            el.style.display = 'none'; // Ocultar inicialmente
            content.innerHTML = '';
            content.className = 'option-content';
            
            const check = el.querySelector('.correct-check');
            if (check) check.style.display = 'none';
            
            const letter_el = el.querySelector('.option-letter');
            if (letter_el) letter_el.style.cssText = '';
        }
    });
    
    if (!editors.correct_answer) {
        alert('❌ Editores ainda não estão prontos!');
        return;
    }
    
    // Adicionar conteúdo normal aos editores
    editors.correct_answer.setText('Esta é a resposta correta!');
    if (editors.option1) editors.option1.setText('Opção incorreta 1');
    if (editors.option2) editors.option2.setText('Opção incorreta 2'); 
    if (editors.option3) editors.option3.setText('Opção incorreta 3');
    
    // Chamar updatePreview normalmente (sem proteções)
    setTimeout(() => {
        window.updatePreview();
        alert('✨ Teste NORMAL executado! Agora está funcionando como deveria funcionar sempre!');
    }, 100);
};

window.debugDetalhado = function() {
    console.clear(); // Limpar console para logs limpos
    console.log('🔬 === DEBUG TOTAL INICIADO ===');
    
    // Desativar todas as proteções
    window.TESTING_MODE = false;
    if (window.protectOptionA) {
        clearInterval(window.protectOptionA);
        window.protectOptionA = null;
    }
    if (window.optionAObserver) {
        window.optionAObserver.disconnect();
        window.optionAObserver = null;
    }
    
    // Verificar se editores existem
    console.log('🔍 Verificando editores...');
    console.log('  - editors objeto:', editors);
    console.log('  - editors.correct_answer:', editors.correct_answer);
    console.log('  - editors.option1:', editors.option1);
    console.log('  - editors.option2:', editors.option2);
    console.log('  - editors.option3:', editors.option3);
    
    if (!editors.correct_answer) {
        alert('❌ Editores não estão prontos! Aguarde o carregamento da página.');
        return;
    }
    
    // Limpar e adicionar conteúdo de teste
    console.log('📝 Adicionando conteúdo de teste aos editores...');
    editors.correct_answer.setText('RESPOSTA CORRETA DE TESTE');
    if (editors.option1) editors.option1.setText('Opção incorreta 1');
    if (editors.option2) editors.option2.setText('Opção incorreta 2');
    if (editors.option3) editors.option3.setText('Opção incorreta 3');
    
    console.log('📝 Conteúdo adicionado! Verificando...');
    console.log('  - Resposta correta texto:', editors.correct_answer.getText());
    console.log('  - Resposta correta HTML:', editors.correct_answer.root.innerHTML);
    
    // Chamar updatePreview com debug ativo
    console.log('🔄 Chamando updatePreview com debug total...');
    
    setTimeout(() => {
        window.updatePreview();
        
        console.log('🔬 === DEBUG TOTAL FINALIZADO ===');
        alert('🔬 Debug Total executado! Veja TODOS os detalhes no console (F12).');
    }, 200);
};

window.testeSemListeners = function() {
    console.clear();
    console.log('🛑 === TESTE SEM LISTENERS ===');
    
    // Desativar TODOS os modos e proteções
    window.TESTING_MODE = false;
    if (window.protectOptionA) {
        clearInterval(window.protectOptionA);
        window.protectOptionA = null;
    }
    if (window.optionAObserver) {
        window.optionAObserver.disconnect();
        window.optionAObserver = null;
    }
    
    if (!editors.correct_answer) {
        alert('❌ Editores não estão prontos!');
        return;
    }
    
    // REMOVER TODOS os listeners dos editores para evitar loop
    console.log('🛑 Removendo todos os listeners dos editores...');
    Object.values(editors).forEach(editor => {
        editor.off('text-change'); // Remove todos os listeners de text-change
    });
    
    // Limpar preview primeiro
    ['a', 'b', 'c', 'd'].forEach(letter => {
        const el = document.getElementById(`preview-option-${letter}`);
        const content = document.getElementById(`preview-content-${letter}`);
        if (el && content) {
            el.classList.remove('is-correct');
            el.style.display = 'none'; // Ocultar inicialmente
            content.innerHTML = '';
            content.className = 'option-content';
            
            const check = el.querySelector('.correct-check');
            if (check) check.style.display = 'none';
            
            const letter_el = el.querySelector('.option-letter');
            if (letter_el) letter_el.style.cssText = '';
        }
    });
    
    // Adicionar conteúdo de teste
    console.log('📝 Adicionando conteúdo de teste...');
    editors.correct_answer.setText('🎯 RESPOSTA CORRETA DEFINITIVA!');
    if (editors.option1) editors.option1.setText('❌ Opção incorreta 1');
    if (editors.option2) editors.option2.setText('❌ Opção incorreta 2');
    if (editors.option3) editors.option3.setText('❌ Opção incorreta 3');
    
    // Ativar modo teste para bloquear futuras chamadas
    window.TESTING_MODE = true;
    console.log('🔒 Modo teste ativado - updatePreview bloqueado para futuras chamadas');
    
    // Chamar updatePreview UMA ÚNICA VEZ
    console.log('🔄 Chamando updatePreview UMA ÚNICA VEZ...');
    window.TESTING_MODE = false; // Permitir esta execução
    
    setTimeout(() => {
        window.updatePreview();
        
        // Reativar bloqueio
        window.TESTING_MODE = true;
        console.log('🔒 Bloqueio reativado - updatePreview não pode mais ser chamado');
        
        console.log('🛑 === TESTE FINALIZADO ===');
        alert('🛑 Teste SEM LISTENERS executado! Agora a resposta correta deve estar FIXA!');
    }, 100);
};

window.testeNormalCompleto = function() {
    console.clear();
    console.log('🎯 === TESTE NORMAL COMPLETO (DEFINITIVO) ===');
    
    // Desativar TODOS os modos de teste e proteções
    window.TESTING_MODE = false;
    if (window.protectOptionA) {
        clearInterval(window.protectOptionA);
        window.protectOptionA = null;
    }
    if (window.optionAObserver) {
        window.optionAObserver.disconnect();
        window.optionAObserver = null;
    }
    
    if (!editors.correct_answer) {
        alert('❌ Editores não estão prontos!');
        return;
    }
    
    // Limpar TODOS os listeners antigos primeiro
    console.log('🔄 Removendo listeners antigos...');
    Object.values(editors).forEach(editor => {
        editor.off('text-change');
    });
    
    // Recrear listeners com a lógica NOVA e ROBUSTA
    console.log('🔧 Criando listeners robustos...');
    let updateTimeout;
    let isUpdating = false;
    
    Object.values(editors).forEach(editor => {
        editor.on('text-change', function(delta, oldDelta, source) {
            // Ignorar mudanças programáticas para evitar loops
            if (source === 'api' || isUpdating) {
                console.log('⏭️ Mudança ignorada (source:', source, ', isUpdating:', isUpdating, ')');
                return;
            }
            
            console.log('👤 Mudança do usuário detectada');
            
            // Cancelar timeout anterior
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            // Agendar nova execução
            updateTimeout = setTimeout(() => {
                isUpdating = true;
                console.log('🔄 Executando updatePreview...');
                
                try {
                    window.updatePreview();
                    window.checkFormValidity();
                    console.log('✅ updatePreview executado com sucesso');
                } catch (error) {
                    console.error('❌ Erro no updatePreview:', error);
                } finally {
                    isUpdating = false;
                    console.log('🏁 Flag isUpdating liberada');
                }
            }, 500);
        });
    });
    
    // Limpar preview
    ['a', 'b', 'c', 'd'].forEach(letter => {
        const el = document.getElementById(`preview-option-${letter}`);
        const content = document.getElementById(`preview-content-${letter}`);
        if (el && content) {
            el.classList.remove('is-correct');
            el.style.display = 'none'; // Ocultar inicialmente
            content.innerHTML = '';
            content.className = 'option-content';
            
            const check = el.querySelector('.correct-check');
            if (check) check.style.display = 'none';
            
            const letter_el = el.querySelector('.option-letter');
            if (letter_el) letter_el.style.cssText = '';
        }
    });
    
    // Limpar editores
    Object.values(editors).forEach(editor => {
        editor.setText('');
    });
    
    console.log('✅ Sistema COMPLETAMENTE RESETADO');
    console.log('🎯 Agora você pode digitar NORMALMENTE!');
    console.log('🎯 A resposta correta deve aparecer automaticamente no preview');
    
    alert('🎯 Sistema RESETADO com nova lógica anti-loop!\n\nAgora digite normalmente:\n1. Uma pergunta\n2. Uma resposta correta\n3. Três opções incorretas\n\nA resposta correta deve aparecer automaticamente no preview!');
};

document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando página de sugestão...');
    
    // Aguardar Quill carregar
    function initializeEditors() {
        if (typeof Quill === 'undefined') {
            console.log('Aguardando Quill carregar...');
            setTimeout(initializeEditors, 100);
            return;
        }

        // console.log('✅ Editores Quill inicializados!');

        // Configuração do Quill
        const quillConfig = {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    ['formula'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        };

        try {
            // Criar editor de pergunta
            editors.question = new Quill('#question-editor', {
                ...quillConfig,
                placeholder: 'Digite sua pergunta aqui...'
            });

            // Criar editor de resposta correta
            editors.correct_answer = new Quill('#correct-answer-editor', {
                ...quillConfig,
                placeholder: 'Digite a resposta correta...'
            });

            // Criar editores de opções incorretas
            editors.option1 = new Quill('#option1-editor', {
                ...quillConfig,
                placeholder: 'Primeira alternativa incorreta...'
            });

            editors.option2 = new Quill('#option2-editor', {
                ...quillConfig,
                placeholder: 'Segunda alternativa incorreta...'
            });

            editors.option3 = new Quill('#option3-editor', {
                ...quillConfig,
                placeholder: 'Terceira alternativa incorreta...'
            });

            // Adicionar listeners para atualização em tempo real (com debounce robusto)
            let updateTimeout;
            let isUpdating = false; // Flag para evitar loops
            
            Object.values(editors).forEach(editor => {
                editor.on('text-change', function(delta, oldDelta, source) {
                    // Ignorar mudanças programáticas (API) para evitar loops
                    if (source === 'api' || isUpdating || window.TESTING_MODE) {
                        return;
                    }
                    
                    // Cancelar timeout anterior
                    if (updateTimeout) {
                        clearTimeout(updateTimeout);
                    }
                    
                    // Agendar nova execução com debounce
                    updateTimeout = setTimeout(() => {
                        isUpdating = true; // Marcar como atualizando
                        
                        try {
                            window.updatePreview();
                            window.checkFormValidity();
                        } catch (error) {
                            console.error('Erro no updatePreview:', error);
                        } finally {
                            isUpdating = false; // Liberar flag
                        }
                    }, 500); // Delay maior para estabilidade
                });
            });

            console.log('✅ Sistema de sugestão de questões carregado!');
            
            // Force initial validation after page load
            setTimeout(() => {
                window.updatePreview();
                window.checkFormValidity();
            }, 500);
            
            // Additional validation triggers for image uploads and other changes
            setInterval(() => {
                // Gentle background validation every 2 seconds to catch any missed events
                if (!isUpdating) {
                    window.checkFormValidity();
                }
            }, 2000);
            
            // Image upload handlers
            const imageInput = document.getElementById('question_image');
            const imagePreview = document.getElementById('image-preview');
            const uploadPlaceholder = document.getElementById('upload-placeholder');
            const previewImg = document.getElementById('preview-img');
            
            if (imageInput) {
                imageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        // Validate file size (5MB max)
                        if (file.size > 5 * 1024 * 1024) {
                            alert('Arquivo muito grande! Máximo 5MB.');
                            this.value = '';
                            return;
                        }
                        
                        // Validate file type
                        if (!file.type.match(/^image\/(png|jpg|jpeg)$/)) {
                            alert('Tipo de arquivo inválido! Use PNG, JPG ou JPEG.');
                            this.value = '';
                            return;
                        }
                        
                        // Show preview
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewImg.src = e.target.result;
                            imagePreview.style.display = 'block';
                            uploadPlaceholder.style.display = 'none';
                            
                            // Re-run validation after image upload
                            setTimeout(() => {
                                window.checkFormValidity();
                            }, 100);
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Remove image function
            window.removeImage = function() {
                imageInput.value = '';
                imagePreview.style.display = 'none';
                uploadPlaceholder.style.display = 'block';
                previewImg.src = '';
                
                // Re-run validation after image removal
                setTimeout(() => {
                    window.checkFormValidity();
                }, 100);
            };
            
        } catch (error) {
            console.error('Erro ao inicializar editores:', error);
        }
    }

    // Atualizar preview (disponível globalmente)
    window.updatePreview = function() {
        // PARAR se estivermos testando
        if (window.TESTING_MODE) {
            console.log('⏸️ updatePreview PAUSADO - modo teste ativo');
            return;
        }
        
        try {
            // Atualizar pergunta preservando formatação
            const questionContent = editors.question ? editors.question.root.innerHTML : '';
            const questionElement = document.getElementById('preview-question');
            if (questionContent.trim() && questionContent !== '<p><br></p>') {
                questionElement.innerHTML = questionContent;
                questionElement.className = 'ql-editor'; // Aplicar classes Quill
            } else {
                questionElement.innerHTML = '<em>Digite sua pergunta para visualizar...</em>';
                questionElement.className = '';
            }

            // Coletar todas as opções
            const allOptions = [];

            // Adicionar resposta correta (SEMPRE incluir se tiver conteúdo)
            if (editors.correct_answer) {
                const correctContent = editors.correct_answer.root.innerHTML;
                const correctText = editors.correct_answer.getText().trim();
                
                // Verificação simples - apenas se há texto
                const hasContent = correctText.length > 0;
                
                if (hasContent) {
                    const correctOption = {
                        content: correctContent,
                        isCorrect: true
                    };
                    allOptions.push(correctOption);
                }
            }

            // Adicionar opções incorretas
            ['option1', 'option2', 'option3'].forEach(key => {
                if (editors[key]) {
                    const content = editors[key].root.innerHTML;
                    if (content && content.trim() && content.trim() !== '<p><br></p>') {
                        allOptions.push({
                            content: content,
                            isCorrect: false
                        });
                    }
                }
            });

            // Criar array dinâmico baseado no número real de opções
            const previewOptions = new Array(4).fill(null);
            
            // Se temos opções, embaralhar e colocar nas primeiras posições
            if (allOptions.length > 0) {
                const shuffled = [...allOptions].sort(() => Math.random() - 0.5);
                for (let i = 0; i < Math.min(shuffled.length, 4); i++) {
                    previewOptions[i] = shuffled[i];
                }
                // console.log(`📊 ${allOptions.length} opções coletadas | Correta: ${allOptions.some(o => o.isCorrect) ? '✅' : '❌'}`);
            }

            // Atualizar preview das opções (SÓ mostra opções com conteúdo)            
            ['a', 'b', 'c', 'd'].forEach((letter, index) => {
                const optionElement = document.getElementById(`preview-option-${letter}`);
                const contentElement = document.getElementById(`preview-content-${letter}`);
                
                // Verificar se os elementos existem
                if (!optionElement || !contentElement) {
                    console.error(`❌ Elemento preview-option-${letter} ou preview-content-${letter} não encontrado!`);
                    return;
                }
                
                const checkIcon = optionElement.querySelector('.correct-check');

                if (previewOptions[index] && previewOptions[index].content.trim()) {
                    // TEM conteúdo - mostrar opção
                    optionElement.style.display = 'flex';
                    // Tem conteúdo
                    contentElement.innerHTML = previewOptions[index].content;
                    contentElement.className = 'option-content ql-editor';
                    
                    if (previewOptions[index].isCorrect) {
                        optionElement.classList.add('is-correct');
                        checkIcon.style.display = 'block';
                        
                        // Aplicar estilos diretos (sem animação para não resetar)
                        optionElement.style.cssText = `
                            background: linear-gradient(135deg, #28a745, #20c997) !important;
                            border: 3px solid #28a745 !important;
                            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4) !important;
                            transition: none !important;
                            animation: none !important;
                            display: flex !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                        `;
                        
                        // Estilizar a letra da opção
                        const optionLetter = optionElement.querySelector('.option-letter');
                        if (optionLetter) {
                            optionLetter.style.cssText = `
                                background: #28a745 !important;
                                border: 2px solid #20c997 !important;
                                color: white !important;
                                font-weight: bold !important;
                            `;
                        }
                        
                        // console.log(`✅ Resposta correta aplicada na opção ${letter.toUpperCase()}`);
                        
                    } else {
                        optionElement.classList.remove('is-correct');
                        checkIcon.style.display = 'none';
                        
                        // Resetar estilos inline para opções incorretas
                        optionElement.style.cssText = '';
                        const optionLetter = optionElement.querySelector('.option-letter');
                        if (optionLetter) {
                            optionLetter.style.cssText = '';
                        }
                    }
                } else {
                    // SEM conteúdo - OCULTAR completamente a opção
                    optionElement.style.display = 'none';
                    contentElement.innerHTML = '';
                    contentElement.className = 'option-content';
                    optionElement.classList.remove('is-correct');
                    checkIcon.style.display = 'none';
                }
            });

            // Atualizar metadata (simplified)
            const topicValue = document.getElementById('topic').value;
            const metaTopic = document.getElementById('meta-topic');
            if (metaTopic) {
                metaTopic.textContent = topicValue === 'novo_tema' 
                    ? document.getElementById('new_topic').value || '-'
                    : topicValue || '-';
            }
            
            // For grade, check which type
            const metaGrade = document.getElementById('meta-grade');
            if (metaGrade) {
                if (topicValue === 'SAT') {
                    const satSection = document.getElementById('sat_section');
                    const satLevel = document.getElementById('sat_level');
                    const sectionText = satSection ? satSection.value || '-' : '-';
                    const levelText = satLevel ? satLevel.value || '-' : '-';
                    metaGrade.textContent = `${sectionText} ${levelText}`;
                } else {
                    const gradeField = document.getElementById('grade');
                    metaGrade.textContent = gradeField ? gradeField.value || '-' : '-';
                }
            }
            
            // Set defaults for difficulty and points
            const metaDifficulty = document.getElementById('meta-difficulty');
            if (metaDifficulty) metaDifficulty.textContent = 'Médio';
            
            const metaPoints = document.getElementById('meta-points');
            if (metaPoints) metaPoints.textContent = '10';
                
        } catch (error) {
            console.error('Erro ao atualizar preview:', error);
        }
    }

    // Verificar validade do formulário progressivo
    window.checkFormValidity = function() {
        try {
            const topic = document.getElementById('topic').value;
            const newTopic = document.getElementById('new_topic').value;
            // Skip difficulty and points since they're hidden defaults now

            // Debug validation  
            let topicValid = false;
            let gradeValid = false;
            
            console.log('🔍 FORM VALIDATION DEBUG:');
            console.log('  Topic:', topic);
            
            if (topic === 'SAT') {
                const satSection = document.getElementById('sat_section').value;
                const satLevel = document.getElementById('sat_level').value;
                console.log('  SAT Section:', satSection);
                console.log('  SAT Level:', satLevel);
                topicValid = satSection && satLevel;
                gradeValid = true; // SAT doesn't need regular grade
            } else if (topic === 'novo_tema') {
                console.log('  New Topic:', newTopic);
                topicValid = newTopic.trim();
                gradeValid = document.getElementById('grade').value;
            } else if (topic) {
                topicValid = true;
                const grade = document.getElementById('grade').value;
                console.log('  Grade:', grade);
                gradeValid = grade;
            }

            const hasQuestion = editors.question && editors.question.getText().trim().length > 0;
            const hasCorrectAnswer = editors.correct_answer && editors.correct_answer.getText().trim().length > 0;
            const hasOption1 = editors.option1 && editors.option1.getText().trim().length > 0;
            const hasOption2 = editors.option2 && editors.option2.getText().trim().length > 0;
            const hasOption3 = editors.option3 && editors.option3.getText().trim().length > 0;

            console.log('  Topic Valid:', topicValid);
            console.log('  Grade Valid:', gradeValid);
            console.log('  Has Question:', hasQuestion);
            console.log('  Has Correct Answer:', hasCorrectAnswer);
            console.log('  Has Option1:', hasOption1);
            console.log('  Has Option2:', hasOption2);
            console.log('  Has Option3:', hasOption3);

            // Simplified validation - no difficulty/points required - IMAGE IS OPTIONAL
            const isValid = topicValid && gradeValid && 
                           hasQuestion && hasCorrectAnswer && 
                           hasOption1 && hasOption2 && hasOption3;
                           
            console.log('  ✅ FINAL RESULT:', isValid);

            const submitBtn = document.getElementById('submit-btn');
            if (submitBtn) {
                submitBtn.disabled = !isValid;
                
                // Visual feedback on button
                if (isValid) {
                    {% if can_bypass %}
                        {% if is_admin %}
                        submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Adicionar Questão Diretamente';
                        {% else %}
                        submitBtn.innerHTML = '<i class="fas fa-star"></i> Adicionar como Colaborador';
                        {% endif %}
                    {% else %}
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar Questão';
                    {% endif %}
                    submitBtn.classList.remove('btn-secondary');
                    submitBtn.classList.add('btn-success');
                } else {
                    {% if can_bypass %}
                    submitBtn.innerHTML = '<i class="fas fa-lock"></i> Complete todos os campos para adicionar';
                    {% else %}
                    submitBtn.innerHTML = '<i class="fas fa-lock"></i> Complete todos os campos';
                    {% endif %}
                    submitBtn.classList.remove('btn-success');
                    submitBtn.classList.add('btn-secondary');
                }
            }
            
        } catch (error) {
            console.error('Erro ao verificar validade:', error);
        }
    }

    // Progressive Step Management
    document.getElementById('topic').addEventListener('change', function() {
        const newTopicInput = document.getElementById('new_topic');
        const step2a = document.getElementById('step-2a'); // SAT options
        const step2b = document.getElementById('step-2b'); // Grade selection
        
        // Reset all steps except step 1
        [step2a, step2b].forEach(step => {
            if (step) {
                step.style.display = 'none';
                step.classList.remove('active');
            }
        });
        
        // Handle new subject input
        newTopicInput.style.display = this.value === 'novo_tema' ? 'block' : 'none';
        if (this.value === 'novo_tema') {
            newTopicInput.focus();
            // For new topic, show grade selection
            if (step2b) {
                step2b.style.display = 'block';
                step2b.classList.add('active');
            }
        } else if (this.value === 'SAT') {
            // SAT flow: show SAT configuration only
            if (step2a) {
                step2a.style.display = 'block';
                step2a.classList.add('active');
            }
            const satSection = document.getElementById('sat_section');
            const satLevel = document.getElementById('sat_level');
            const gradeField = document.getElementById('grade');
            
            if (satSection) satSection.required = true;
            if (satLevel) satLevel.required = true;
            if (gradeField) gradeField.required = false;
        } else if (this.value && this.value !== '') {
            // Regular subject flow: show grade selection only
            if (step2b) {
                step2b.style.display = 'block';
                step2b.classList.add('active');
            }
            const gradeField = document.getElementById('grade');
            const satSection = document.getElementById('sat_section');
            const satLevel = document.getElementById('sat_level');
            
            if (gradeField) gradeField.required = true;
            if (satSection) satSection.required = false;
            if (satLevel) satLevel.required = false;
        }
        
        window.updatePreview();
        window.checkFormValidity();
    });

    // SAT configuration completed - just update validation
    ['sat_section', 'sat_level'].forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
            field.addEventListener('change', function() {
                window.updatePreview();
                window.checkFormValidity();
            });
        }
    });

    // Listeners para outros campos (incluindo SAT)
    ['grade', 'new_topic', 'sat_section', 'sat_level'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', function() {
                window.updatePreview();
                window.checkFormValidity();
            });
        }
    });

    // Submissão do formulário
    document.getElementById('suggest-form').addEventListener('submit', function(e) {
        e.preventDefault();

        // Atualizar campos hidden
        document.querySelector('input[name="question"]').value = 
            editors.question.root.innerHTML;
        document.querySelector('input[name="correct_answer"]').value = 
            editors.correct_answer.root.innerHTML;
        document.querySelector('input[name="option1"]').value = 
            editors.option1.root.innerHTML;
        document.querySelector('input[name="option2"]').value = 
            editors.option2.root.innerHTML;
        document.querySelector('input[name="option3"]').value = 
            editors.option3.root.innerHTML;

        // Adicionar estado de loading
        const btn = document.getElementById('submit-btn');
        {% if can_bypass %}
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adicionando questão...';
        {% else %}
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando sugestão...';
        {% endif %}
        btn.disabled = true;

        // Submeter formulário
        this.submit();
    });

    // Função simples para testar Quill quando estiver pronto
    window.testQuillContent = function() {
        if (editors.correct_answer) {
            editors.correct_answer.setText('Teste de resposta correta');
            setTimeout(() => window.updatePreview(), 100);
        } else {
            alert('Editores ainda não estão prontos');
        }
    };

    // Inicializar
    initializeEditors();
});
</script>
{% endblock %}
