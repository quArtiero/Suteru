{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/add_quiz.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>Editar Questão</h2>
    <form method="POST">
        <!-- Campos adicionais -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="topic">Tópico</label>
                    <select class="form-control" id="topic" name="topic" required>
                        {% for topic in topics %}
                            <option value="{{ topic }}" {% if topic == question[8] %}selected{% endif %}>{{ topic }}</option>
                        {% endfor %}
                        <option value="novo_tema">Novo Tópico</option>
                    </select>
                    <input type="text" class="form-control mt-2" id="new_topic" name="new_topic" 
                           style="display: none;" placeholder="Digite o novo tópico">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="grade">Série Escolar</label>
                    <select class="form-control" id="grade" name="grade" required>
                        {% for grade in grades %}
                            <option value="{{ grade }}" {% if grade == question[9] %}selected{% endif %}>{{ grade }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <!-- Editor de Questão -->
        <div class="form-group mb-4">
            <label for="question">Pergunta</label>
            <div id="question-editor"></div>
            <input type="hidden" name="question">
        </div>

        <div class="form-group mb-4">
            <label for="correct_answer">Resposta Correta</label>
            <div id="correct-answer-editor"></div>
            <input type="hidden" name="correct_answer">
        </div>

        <div class="form-group mb-4">
            <label for="option1">Opção 1</label>
            <div id="option1-editor"></div>
            <input type="hidden" name="option1">
        </div>

        <div class="form-group mb-4">
            <label for="option2">Opção 2</label>
            <div id="option2-editor"></div>
            <input type="hidden" name="option2">
        </div>

        <div class="form-group mb-4">
            <label for="option3">Opção 3</label>
            <div id="option3-editor"></div>
            <input type="hidden" name="option3">
        </div>

        <div class="form-group mb-4">
            <label for="option4">Opção 4</label>
            <div id="option4-editor"></div>
            <input type="hidden" name="option4">
        </div>

        <div class="form-group mb-4">
            <label for="points">Pontos:</label>
            <input type="number" class="form-control" id="points" name="points" value="{{ question[7] }}" required min="0">
        </div>

        <!-- Preview da Questão -->
        <div class="mt-5 mb-4">
            <h4 class="text-primary mb-3">Preview da Questão</h4>
            <div class="card quiz-card">
                <div class="card-body">
                    <div class="question-content mb-4">
                        <div class="ql-snow">
                            <div class="ql-editor" id="preview-question"></div>
                        </div>
                    </div>

                    <div class="options-list">
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" disabled>
                            <label class="form-check-label">
                                <div class="ql-snow">
                                    <div class="ql-editor" id="preview-option1"></div>
                                </div>
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" disabled>
                            <label class="form-check-label">
                                <div class="ql-snow">
                                    <div class="ql-editor" id="preview-option2"></div>
                                </div>
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" disabled>
                            <label class="form-check-label">
                                <div class="ql-snow">
                                    <div class="ql-editor" id="preview-option3"></div>
                                </div>
                            </label>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" disabled>
                            <label class="form-check-label">
                                <div class="ql-snow">
                                    <div class="ql-editor" id="preview-option4"></div>
                                </div>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">Atualizar Questão</button>
    </form>
</div>

<script>
// Wait for both DOM and Quill to be ready
function initializeEditors() {
    console.log('Initializing editors...');
    console.log('Quill available:', typeof Quill !== 'undefined');
    
    if (typeof Quill === 'undefined') {
        console.error('Quill library not loaded');
        setTimeout(initializeEditors, 100);
        return;
    }

    try {
        // Check if editor containers exist
        const editorIds = ['question-editor', 'correct-answer-editor', 'option1-editor', 'option2-editor', 'option3-editor', 'option4-editor'];
        const missingEditors = editorIds.filter(id => !document.getElementById(id));
        
        if (missingEditors.length > 0) {
            console.error('Missing editor containers:', missingEditors);
            return;
        }

        console.log('Creating editor configuration...');
        const editorConfig = {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    ['image', 'formula'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                ]
            },
            placeholder: 'Digite aqui...'
        };

        console.log('Initializing editors...');
        const editors = {
            question: new Quill('#question-editor', editorConfig),
            correct_answer: new Quill('#correct-answer-editor', editorConfig),
            option1: new Quill('#option1-editor', editorConfig),
            option2: new Quill('#option2-editor', editorConfig),
            option3: new Quill('#option3-editor', editorConfig),
            option4: new Quill('#option4-editor', editorConfig)
        };

        // Pre-fill editors with existing content
        console.log('Pre-filling editors with existing content...');
        editors.question.root.innerHTML = '{{ quiz.question|safe }}';
        editors.correct_answer.root.innerHTML = '{{ quiz.correct_answer|safe }}';
        editors.option1.root.innerHTML = '{{ quiz.option1|safe }}';
        editors.option2.root.innerHTML = '{{ quiz.option2|safe }}';
        editors.option3.root.innerHTML = '{{ quiz.option3|safe }}';
        editors.option4.root.innerHTML = '{{ quiz.option4|safe }}';

        console.log('Setting up preview function...');
        function updatePreview() {
            try {
                document.getElementById('preview-question').innerHTML = editors.question.root.innerHTML;
                document.getElementById('preview-option1').innerHTML = editors.option1.root.innerHTML;
                document.getElementById('preview-option2').innerHTML = editors.option2.root.innerHTML;
                document.getElementById('preview-option3').innerHTML = editors.option3.root.innerHTML;
                document.getElementById('preview-option4').innerHTML = editors.option4.root.innerHTML;

                document.querySelectorAll('#preview-question .ql-formula, #preview-option1 .ql-formula, #preview-option2 .ql-formula, #preview-option3 .ql-formula, #preview-option4 .ql-formula').forEach(function(formula) {
                    katex.render(formula.getAttribute('data-value'), formula, {
                        throwOnError: false
                    });
                });
            } catch (error) {
                console.error('Error updating preview:', error);
            }
        }

        console.log('Setting up event listeners...');
        Object.values(editors).forEach(editor => {
            editor.on('text-change', updatePreview);
        });

        document.querySelector('form').onsubmit = function() {
            for (let field in editors) {
                document.querySelector(`input[name=${field}]`).value = editors[field].root.innerHTML;
            }
        };

        // Handle new topic input visibility
        const topicSelect = document.getElementById('topic');
        const newTopicInput = document.getElementById('new_topic');
        
        if (topicSelect && newTopicInput) {
            topicSelect.addEventListener('change', function() {
                newTopicInput.style.display = this.value === 'novo_tema' ? 'block' : 'none';
            });
        }

        console.log('Initial preview update...');
        updatePreview();
        console.log('Editor initialization complete!');
    } catch (error) {
        console.error('Error initializing Quill editors:', error);
        console.error('Error stack:', error.stack);
    }
}

// Try to initialize immediately if Quill is already loaded
if (typeof Quill !== 'undefined') {
    console.log('Quill already loaded, initializing immediately...');
    initializeEditors();
} else {
    console.log('Waiting for DOM and Quill to load...');
    document.addEventListener('DOMContentLoaded', function() {
        // Add a small delay to ensure Quill is loaded
        setTimeout(initializeEditors, 100);
    });
}
</script>
{% endblock %}
