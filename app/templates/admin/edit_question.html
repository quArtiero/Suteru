{% extends "base.html" %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/suggest_question.css') }}">
{% endblock %}

{% block content %}
<div class="suggest-question-container">
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="hero-icon">
            <i class="fas fa-edit"></i>
        </div>
        <h1 class="hero-title">Editar Quest√£o #{{ quiz[0] }}</h1>
        <p class="hero-subtitle">Edite esta quest√£o mantendo a mesma l√≥gica da p√°gina de sugerir</p>
    </div>

    <!-- Main Form -->
    <div class="main-form-card">
        <form method="POST" id="edit-form">
            <!-- Step 1: Choose Subject -->
            <div class="step-section active">
                <div class="step-header">
                    <span class="step-number">1</span>
                    <h4 class="step-title">Escolha a Mat√©ria</h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="topic">
                        <i class="fas fa-book"></i>
                        Mat√©ria
                    </label>
                    <select class="form-control" id="topic" name="topic" required>
                        <option value="" disabled>Selecione a mat√©ria</option>
                        <option value="SAT" {% if quiz[8].startswith('SAT') or 'SAT' in quiz[7] %}selected{% endif %}>SAT</option>
                        {% for topic in topics %}
                        {% if not topic.startswith('SAT') %}
                        <option value="{{ topic }}" {% if topic == quiz[8] and 'SAT' not in quiz[7] %}selected{% endif %}>{{ topic }}</option>
                        {% endif %}
                        {% endfor %}
                        <option value="novo_tema">‚ûï Nova Mat√©ria</option>
                    </select>
                    <input type="text" class="form-control mt-2" id="new_topic" name="new_topic" 
                           style="display: none;" placeholder="Digite a nova mat√©ria">
                </div>
            </div>

            <!-- Step 2a: SAT Configuration -->
            <div class="step-section" id="step-2a" style="display: none;">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <h4 class="step-title">Configura√ß√£o SAT</h4>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="sat_section">
                                <i class="fas fa-university"></i>
                                Se√ß√£o SAT
                            </label>
                            <select class="form-control" id="sat_section" name="sat_section">
                                <option value="" disabled>Selecione a se√ß√£o</option>
                                <option value="english">üìö English Reading & Writing</option>
                                <option value="math">üî¢ Math</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group">
                            <label class="form-label" for="sat_level">
                                <i class="fas fa-star"></i>
                                N√≠vel
                            </label>
                            <select class="form-control" id="sat_level" name="sat_level">
                                <option value="" disabled>Selecione o n√≠vel</option>
                                <option value="Level 1">‚≠ê Level 1 - Iniciante</option>
                                <option value="Level 2">‚≠ê‚≠ê Level 2 - Intermedi√°rio</option>
                                <option value="Level 3">‚≠ê‚≠ê‚≠ê Level 3 - Avan√ßado</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Step 2b: Regular Grade Selection -->
            <div class="step-section" id="step-2b" style="display: none;">
                <div class="step-header">
                    <span class="step-number">2</span>
                    <h4 class="step-title">Escolha a S√©rie</h4>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="grade">
                        <i class="fas fa-graduation-cap"></i>
                        S√©rie Escolar
                    </label>
                    <select class="form-control" id="grade" name="grade">
                        <option value="" disabled>Selecione a s√©rie</option>
                        {% for grade in grades %}
                        <option value="{{ grade }}" {% if grade == quiz[7] %}selected{% endif %}>{{ grade }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Campos hidden -->
            <input type="hidden" name="difficulty" value="medio">
            <input type="hidden" name="points" value="{{ quiz[9] }}">

            <!-- Question Section -->
            <div class="section-header mt-5">
                <div class="section-icon">
                    <i class="fas fa-question-circle"></i>
                </div>
                <h2 class="section-title">Conte√∫do da Quest√£o</h2>
            </div>

            <!-- Question Editor -->
            <div class="form-group">
                <label class="form-label">
                    <i class="fas fa-pen"></i>
                    Pergunta
                </label>
                <div class="editor-wrapper">
                    <div id="question-editor" style="min-height: 120px;"></div>
                </div>
                <input type="hidden" name="question">
            </div>

            <!-- Correct Answer -->
            <div class="form-group">
                <label class="form-label text-success">
                    <i class="fas fa-check-circle"></i>
                    Resposta Correta
                </label>
                <div class="editor-wrapper correct-answer-wrapper">
                    <div class="correct-answer-badge">
                        <i class="fas fa-check"></i>
                        CORRETA
                    </div>
                    <div id="correct-answer-editor" style="min-height: 120px;"></div>
                </div>
                <input type="hidden" name="correct_answer">
            </div>

            <!-- Incorrect Options -->
            <div class="incorrect-options-section">
                <div class="options-header">
                    <label class="form-label text-warning mb-0">
                        <i class="fas fa-times-circle"></i>
                        Alternativas Incorretas
                    </label>
                    <span class="text-muted">3 alternativas obrigat√≥rias</span>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="option-card">
                            <div class="option-number">1</div>
                            <div class="editor-wrapper" style="margin-left: 40px;">
                                <div id="option1-editor" style="min-height: 100px;"></div>
                            </div>
                            <input type="hidden" name="option1">
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="option-card">
                            <div class="option-number">2</div>
                            <div class="editor-wrapper" style="margin-left: 40px;">
                                <div id="option2-editor" style="min-height: 100px;"></div>
                            </div>
                            <input type="hidden" name="option2">
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="option-card">
                            <div class="option-number">3</div>
                            <div class="editor-wrapper" style="margin-left: 40px;">
                                <div id="option3-editor" style="min-height: 100px;"></div>
                            </div>
                            <input type="hidden" name="option3">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Campo hidden para option4 -->
            <input type="hidden" name="option4" value="{{ quiz[6] if quiz[6] else '' }}">

            <!-- Submit Button -->
            <div class="submit-section">
                <button type="submit" class="submit-btn btn-success" id="submit-btn">
                    <i class="fas fa-save"></i>
                    Atualizar Quest√£o
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// EXATAMENTE IGUAL √Ä SUGGEST_QUESTION
let editors = {};

document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando p√°gina de edi√ß√£o...');
    
    function initializeEditors() {
        if (typeof Quill === 'undefined') {
            setTimeout(initializeEditors, 100);
            return;
        }

        const quillConfig = {
            theme: 'snow',
            modules: {
                toolbar: [
                    ['bold', 'italic', 'underline'],
                    ['formula'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['clean']
                ]
            }
        };

        try {
            editors.question = new Quill('#question-editor', {
                ...quillConfig,
                placeholder: 'Digite sua pergunta aqui...'
            });

            editors.correct_answer = new Quill('#correct-answer-editor', {
                ...quillConfig,
                placeholder: 'Digite a resposta correta...'
            });

            editors.option1 = new Quill('#option1-editor', {
                ...quillConfig,
                placeholder: 'Primeira alternativa incorreta...'
            });

            editors.option2 = new Quill('#option2-editor', {
                ...quillConfig,
                placeholder: 'Segunda alternativa incorreta...'
            });

            editors.option3 = new Quill('#option3-editor', {
                ...quillConfig,
                placeholder: 'Terceira alternativa incorreta...'
            });

            // Pr√©-preencher com dados existentes
            setTimeout(() => {
                editors.question.root.innerHTML = `{{ quiz[1]|safe }}`;
                editors.correct_answer.root.innerHTML = `{{ quiz[2]|safe }}`;
                editors.option1.root.innerHTML = `{{ quiz[3]|safe }}`;
                editors.option2.root.innerHTML = `{{ quiz[4]|safe }}`;
                editors.option3.root.innerHTML = `{{ quiz[5]|safe }}`;
                
                console.log('‚úÖ Dados carregados!');
            }, 200);

            console.log('‚úÖ Editores inicializados!');
            
        } catch (error) {
            console.error('Erro:', error);
        }
    }

    // Progressive Step Management (IGUAL √Ä SUGGEST_QUESTION)
    document.getElementById('topic').addEventListener('change', function() {
        const newTopicInput = document.getElementById('new_topic');
        const step2a = document.getElementById('step-2a'); // SAT options
        const step2b = document.getElementById('step-2b'); // Grade selection
        
        // Reset steps
        [step2a, step2b].forEach(step => {
            if (step) {
                step.style.display = 'none';
                step.classList.remove('active');
            }
        });
        
        // Handle logic
        newTopicInput.style.display = this.value === 'novo_tema' ? 'block' : 'none';
        if (this.value === 'novo_tema') {
            newTopicInput.focus();
            if (step2b) {
                step2b.style.display = 'block';
                step2b.classList.add('active');
            }
        } else if (this.value === 'SAT') {
            if (step2a) {
                step2a.style.display = 'block';
                step2a.classList.add('active');
            }
        } else if (this.value && this.value !== '') {
            if (step2b) {
                step2b.style.display = 'block';
                step2b.classList.add('active');
            }
        }
    });

    // INTERFACE INTELIGENTE: Detecta formatos SAT existentes SEM mexer no banco
    const currentTopic = '{{ quiz[8] }}';
    const currentGrade = '{{ quiz[7] }}';
    
    console.log('üîç Analisando quest√£o:', { currentTopic, currentGrade });
    
    // Detectar se √© quest√£o SAT (m√∫ltiplos formatos)
    const isSATQuestion = currentTopic.includes('SAT') || currentGrade.includes('SAT') || currentTopic.includes('Level');
    
    if (isSATQuestion) {
        console.log('‚úÖ Quest√£o SAT detectada - adaptando interface...');
        
        // FOR√áAR sele√ß√£o de "SAT" no dropdown (esconder os formatos antigos)
        document.getElementById('topic').value = 'SAT';
        
        // Trigger change event para mostrar campos SAT
        document.getElementById('topic').dispatchEvent(new Event('change'));
        
        // Configurar campos SAT baseado nos dados existentes
        setTimeout(() => {
            // Detectar se√ß√£o (English ou Math)
            if (currentTopic.includes('English') || currentGrade.includes('English')) {
                document.getElementById('sat_section').value = 'english';
                console.log('üìö Se√ß√£o detectada: English');
            } else if (currentTopic.includes('Math') || currentGrade.includes('Math')) {
                document.getElementById('sat_section').value = 'math';
                console.log('üî¢ Se√ß√£o detectada: Math');
            }
            
            // Detectar n√≠vel (Level 1/2/3)
            if (currentTopic.includes('Level 1') || currentGrade.includes('Level 1')) {
                document.getElementById('sat_level').value = 'Level 1';
                console.log('‚≠ê N√≠vel detectado: Level 1');
            } else if (currentTopic.includes('Level 2') || currentGrade.includes('Level 2')) {
                document.getElementById('sat_level').value = 'Level 2';
                console.log('‚≠ê‚≠ê N√≠vel detectado: Level 2');
            } else if (currentTopic.includes('Level 3') || currentGrade.includes('Level 3')) {
                document.getElementById('sat_level').value = 'Level 3';
                console.log('‚≠ê‚≠ê‚≠ê N√≠vel detectado: Level 3');
            }
            
            console.log('‚úÖ Interface SAT configurada automaticamente!');
        }, 100);
        
    } else {
        console.log('üìö Quest√£o regular - usando interface padr√£o');
        // Quest√£o regular - mostrar s√©rie
        document.getElementById('step-2b').style.display = 'block';
        document.getElementById('step-2b').classList.add('active');
    }

    // Submiss√£o do formul√°rio
    document.getElementById('edit-form').addEventListener('submit', function(e) {
        e.preventDefault();

        // Atualizar campos hidden
        document.querySelector('input[name="question"]').value = 
            editors.question.root.innerHTML;
        document.querySelector('input[name="correct_answer"]').value = 
            editors.correct_answer.root.innerHTML;
        document.querySelector('input[name="option1"]').value = 
            editors.option1.root.innerHTML;
        document.querySelector('input[name="option2"]').value = 
            editors.option2.root.innerHTML;
        document.querySelector('input[name="option3"]').value = 
            editors.option3.root.innerHTML;

        // Feedback visual
        const btn = document.getElementById('submit-btn');
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Salvando...';
        btn.disabled = true;

        // Submeter formul√°rio
        this.submit();
    });

    // Inicializar
    initializeEditors();
});
</script>
{% endblock %}
